---
title: "既存JavaプロジェクトをModule System(Project Jigsaw)に対応させるステップ"
description: "既存JavaアプリケーションをJava9のProject Jigsaw(Modular System)に適用させるための5ステップ。これからのJavaでエンジニアが抑えておきたいポイントを紹介"
date: 2018-02-04 00:00:00 +0900
categories: java
tags: java java9 modular jigsaw gradle springboot modulepath JPMS
lang: ja
---

* Table Of Contents
{:toc}

## はじめに
今回はJava 9で追加されたModule System移行に関して説明します。
自身で手を動かすことで、JavaのプロダクションコードをJPMSに適用するための作業手順の目処がたったのでまとめておきます。

実は社内向けにも同様の発表はしていて、その際のスライドは以下になります。
少しネガティブなニュアンスで資料を書いていますが、社内の(いろんな意味で)危機意識を煽るため、という背景もあったので、その点ご了承ください。

## 注意点
2018/1時点での情報を基に記載をしていますので、今後変更になる可能性があります。
最新の情報と照らし合わせながら適宜情報の補填を行っていただければと思います。

## どうなる？これからのJava
ここではまず最初に、足元のJPMSの話ではなく、Javaエンジニアが把握しておくべき今後の全体的な流れについて触れておきます。

### 半年に1度訪れるJava SEのリリース
昨年のJava Oneにて Java9 以降のJavaのリリースロードマップが発表されました。
要点だけまとめると以下になります。

* リリース頻度は半年に1度(次は2018/3、その次は2018/9)
* バージョニングは `9`, `10`, `11`
    * Oracle社のページでは `yy.MM` 形式で記載されているで注意
* 時間軸でリリースがされていくため、期限までに実装終了したフィーチャーがリリース対象の機能として取り込まれる
    * early access buildはリリース3ヶ月前から提供される

### ウォッチすべき話題はJavaのサポート期限
Javaのリリースロードマップの中で注目すべきは **サポート期限** です。
リリースラインが1本化されたことで、**複数のJavaのバージョンが並行サポートされることがなくなり** ます。
例えば、Java 10が出たら、Java 9はその時点でサポート終了ということです。
つまり、Javaの進化に合わせて、自分のプロダクトも追随していく必要がある、というわけです。

ルールとして一見わかりやすくはあるものの、以下のようなプロジェクトの場合はJavaのリリースサイクルに追従していくのは容易なことではありません。
* リリースサイクルが長い
* リリースタイミングが柔軟にコントロールできない
* テストコード(非機能含む)が整備されていない

そのようなプロジェクトの場合には、Oracle社からの長期サポートを受けるなどして適宜自分たちのペースでマイグレーション計画をしていくことになるでしょう。

### Java8はいつまでサポートされるか
実は **2018/01/31現在でOracle社がJava 8のサポートを2018/09→2019/01へ延長した** こともあり、実際どうなるかはまだわかりません。 **いつJava8から移行するか**を決断するための材料としても、「Javaのサポート期限」の話題は今後も慎重にウォッチした方が良いでしょう。

### 他にも気をつけておいた方が良いこと

Javaが先程のリリースサイクルになった場合に他に留意すべき点も補足しておきます。
以下のようなケースには、情報収集やearly access buildでの動作確認を早めにしておくと良いと考えています。

* 周辺のエコシステムが追従できているか
    * アプリケーションを構成する依存ライブラリ
    * 実行環境として使用するパブリッククラウド
* 重要な仕様変更が入っているか
    * JPMSのような大きな仕様変更
    * パッケージの移動や非推奨になったAPI

## Module Systemへのマイグレーションに挑戦
Java9で導入された `Java Platform Module System(JPMS)` の仕様により、
JDKを差し替えただけでは既存のJavaアプリケーションが動かない可能性が高いです。
そのため、Module Systemに対応するためにはいくつか段階を経る必要があります。

### 基本方針
* 変更はできるだけ小さいステップで行う


### Step 1. Module Systemの基礎を勉強する
まず、Module Systemに関する知識がなければModule Systemの勉強をしましょう。
私の場合、ヌーラボさんが「[ヌーラボのアカウント基盤を Java 9 にマイグレーションして起きた問題と解決法](https://nulab-inc.com/ja/blog/nulab/java9-migration/)」 にて紹介されているを参考に学習しました。

* [Virtual Java User GroupのJava9マイグレーション動画](https://www.youtube.com/watch?v=NKY2FYTCo7I&t=1905s) を見る
    * Githubにリポジトリも公開されているので、手を動かす
* 書籍 **Java9 Modularity** を読む
    * マイグレーションよりも、modulepathの動きとクラス解決の話を中心に読んだほうが良い
    * 英語弱者もKindleがあればOK

このステップで
* Moduleの種類(Unnamed/Automatic/Named)と違いを理解する
* classpathとmodulepathでのクラスロードの違いを理解する
が身につけばOKだと思います。

やはりCLIで動作確認して動きを

### Step 2. 依存ライブラリのバージョンアップを行う
Step 1で基本が理解できたら、**Java8のうちに依存ライブラリのバージョンアップをやりましょう** 。
今のところJava8/Java9両方をサポートしているライブラリが大半なので、Java8の



### Step 3. Unnamed Moduleにマイグレーションする

### Step 4. Named Moduelにマイグレーションする

### Step 5. 負荷試験とリソースモニタリングをする


## まとめ

### マイグレーション時には細かなリリースをする

## 参考にさせていただいたページ

* [ヌーラボのアカウント基盤を Java 9 にマイグレーションして起きた問題と解決法](https://nulab-inc.com/ja/blog/nulab/java9-migration/)

