<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.2.2 by Michael Rose
  Copyright 2017 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="ja" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>Cloudfront+Lambda@Edgeのサーバレス構成で費用を抑えつつ、動的なWEBコンテンツを作ろう[貧テック] - そうなんでげす</title>




<meta name="description" content="CloudfrontとLambda@Edgeを用いたWEBコンテンツの作成方法を紹介します。パスパラメータ一で動的なURL構成に対応可能で、ロングテールSEOも狙えるようになります。また、サーバレスによってランニングコストを抑えることもできるのでオススメです。">




<meta name="author" content="soudegesu">

<meta property="og:locale" content="ja_JP">
<meta property="og:site_name" content="そうなんでげす">
<meta property="og:title" content="Cloudfront+Lambda@Edgeのサーバレス構成で費用を抑えつつ、動的なWEBコンテンツを作ろう[貧テック]">


  <link rel="canonical" href="https://www.soudegesu.com/aws/hosting-with-cloudfront-lambda-edge-serverless/">
  <meta property="og:url" content="https://www.soudegesu.com/aws/hosting-with-cloudfront-lambda-edge-serverless/">



  <meta property="og:description" content="CloudfrontとLambda@Edgeを用いたWEBコンテンツの作成方法を紹介します。パスパラメータ一で動的なURL構成に対応可能で、ロングテールSEOも狙えるようになります。また、サーバレスによってランニングコストを抑えることもできるのでオススメです。">



  <meta name="twitter:site" content="@alten_manten">
  <meta name="twitter:title" content="Cloudfront+Lambda@Edgeのサーバレス構成で費用を抑えつつ、動的なWEBコンテンツを作ろう[貧テック]">
  <meta name="twitter:description" content="CloudfrontとLambda@Edgeを用いたWEBコンテンツの作成方法を紹介します。パスパラメータ一で動的なURL構成に対応可能で、ロングテールSEOも狙えるようになります。また、サーバレスによってランニングコストを抑えることもできるのでオススメです。">
  <meta name="twitter:url" content="https://www.soudegesu.com/aws/hosting-with-cloudfront-lambda-edge-serverless/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://www.soudegesu.com/assets/images/soudegesu.jpg">
    
  

  
    <meta name="twitter:creator" content="@alten_manten">
  





  <meta property="og:image" content="https://www.soudegesu.com/assets/images/soudegesu.jpg">



  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2018-04-03T00:00:00+09:00">






  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "https://www.soudegesu.com",
      "logo": "https://www.soudegesu.com/assets/images/soudegesu.jpg"
    }
  </script>



  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "soudegsu",
      "url" : "https://www.soudegesu.com",
      "sameAs" : null
    }
  </script>



  <meta name="google-site-verification" content="cTEFKilSiC4rSg768JEVSgidHaZ0Kq9fbgnqqOYW9Uw" />




<!-- end SEO -->


<link href="https://www.soudegesu.com/feed.xml" type="application/atom+xml" rel="alternate" title="そうなんでげす Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="https://www.soudegesu.com/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->

<meta http-equiv="cleartype" content="on">
    <!-- start custom head snippets -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5005266309965277",
    enable_page_level_ads: true
  });
</script>

<!-- end custom head snippets -->
  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="https://www.soudegesu.com/">そうなんでげす</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item"><a href="https://www.soudegesu.com/archives/">Archives</a></li>
          
            
            <li class="masthead__menu-item"><a href="https://www.soudegesu.com/tags/">Tags</a></li>
          
        </ul>
        <button><div class="navicon"></div></button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    



<div id="main" role="main">
  
  <div class="sidebar sticky">
  

<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="https://www.soudegesu.com/assets/images/soudegesu.jpg" class="author__avatar" alt="soudegesu" itemprop="image">
      
    </div>
  

  <div class="author__content">
    <h3 class="author__name" itemprop="name">soudegesu</h3>
    
      <p class="author__bio" itemprop="description">
        Software Engineer
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> <span itemprop="name">Kawasaki, Japan</span>
        </li>
      

      

      

      

      
        <li>
          <a href="https://twitter.com/alten_manten" itemprop="sameAs">
            <i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter
          </a>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/soudegesu" itemprop="sameAs">
            <i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fa fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  

  <!-- under_profile -->
<div align="center">
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-5005266309965277"
     data-ad-slot="2594359046"
     data-ad-format="auto"></ins>
</div>

  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Cloudfront+Lambda@Edgeのサーバレス構成で費用を抑えつつ、動的なWEBコンテンツを作ろう[貧テック]">
    <meta itemprop="description" content="このブログ自体は github-pages と cloudflare を使って無料でホスティングをしているのですが、稀に 「動的なwebコンテンツを提供したい」 と思うことがあります。今回はお金を節約しつつ、動的なwebコンテンツを提供する方法を紹介します。">
    <meta itemprop="datePublished" content="April 03, 2018">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Cloudfront+Lambda@Edgeのサーバレス構成で費用を抑えつつ、動的なWEBコンテンツを作ろう[貧テック]
</h1>
          
            <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  2 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        <p>このブログ自体は <code class="highlighter-rouge">github-pages</code> と <code class="highlighter-rouge">cloudflare</code> を使って無料でホスティングをしているのですが、稀に <strong>「動的なwebコンテンツを提供したい」</strong> と思うことがあります。今回はお金を節約しつつ、動的なwebコンテンツを提供する方法を紹介します。</p>

<ul id="markdown-toc">
  <li><a href="#モチベーション" id="markdown-toc-モチベーション">モチベーション</a>    <ul>
      <li><a href="#動的なwebコンテンツを作りたい" id="markdown-toc-動的なwebコンテンツを作りたい">動的なwebコンテンツを作りたい！</a></li>
      <li><a href="#問題点アクセスが少ない時期はランニングコストが高くつく" id="markdown-toc-問題点アクセスが少ない時期はランニングコストが高くつく">問題点：アクセスが少ない時期はランニングコストが高くつく</a></li>
      <li><a href="#サーバレスで費用を抑えよう" id="markdown-toc-サーバレスで費用を抑えよう">サーバレスで費用を抑えよう</a>        <ul>
          <li><a href="#案1-cloudfront--lambdaedge" id="markdown-toc-案1-cloudfront--lambdaedge">案1 Cloudfront + Lambda@Edge</a></li>
          <li><a href="#案2-api-gateway--lambda" id="markdown-toc-案2-api-gateway--lambda">案2 API Gateway + Lambda</a></li>
          <li><a href="#案3-gcpのgce-f1-micro-インスタンス" id="markdown-toc-案3-gcpのgce-f1-micro-インスタンス">案3 GCPのGCE f1-micro インスタンス</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#awsで構築してみる" id="markdown-toc-awsで構築してみる">AWSで構築してみる</a>    <ul>
      <li><a href="#iam-roleの作成" id="markdown-toc-iam-roleの作成">IAM Roleの作成</a></li>
      <li><a href="#ドメインを設定する" id="markdown-toc-ドメインを設定する">ドメインを設定する</a></li>
      <li><a href="#certification-managerでssl証明書を取得する" id="markdown-toc-certification-managerでssl証明書を取得する">Certification ManagerでSSL証明書を取得する</a></li>
      <li><a href="#lambda関数の作成とpublish" id="markdown-toc-lambda関数の作成とpublish">Lambda関数の作成とpublish</a>        <ul>
          <li><a href="#lambdaedgeはcloudfrontのオリジンリクエスト時に実行させる" id="markdown-toc-lambdaedgeはcloudfrontのオリジンリクエスト時に実行させる">Lambda@EdgeはCloudfrontのオリジンリクエスト時に実行させる</a></li>
          <li><a href="#lambdaedgeからcloudfrontへのレスポンス形式に注意する" id="markdown-toc-lambdaedgeからcloudfrontへのレスポンス形式に注意する">Lambda@EdgeからCloudfrontへのレスポンス形式に注意する</a></li>
        </ul>
      </li>
      <li><a href="#cloudfrontで配信する" id="markdown-toc-cloudfrontで配信する">Cloudfrontで配信する</a>        <ul>
          <li><a href="#lambda関数はpublishして使う" id="markdown-toc-lambda関数はpublishして使う">Lambda関数はpublishして使う</a></li>
          <li><a href="#キャシュクリアをする2回目以降のデプロイ時" id="markdown-toc-キャシュクリアをする2回目以降のデプロイ時">キャシュクリアをする(2回目以降のデプロイ時)</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
  <li><a href="#参考にさせていただいたサイト" id="markdown-toc-参考にさせていただいたサイト">参考にさせていただいたサイト</a></li>
</ul>

<h2 id="モチベーション">モチベーション</h2>
<h3 id="動的なwebコンテンツを作りたい">動的なwebコンテンツを作りたい！</h3>
<p>Google Adsense等を使った広告収入で小遣い稼ぎをしたいと思った場合に、
<code class="highlighter-rouge">はてなブログ</code> のような無料ブログサービスや <code class="highlighter-rouge">Github Pages</code> を利用すると、主に静的ファイルでのコンテンツ配信が中心になります。
1ページあたり1記事を作成する必要があり、1ページあたりの作成コストが高くなるデメリットがあるため、
リクエストパラメータないしはパスパラメータを使ってサーバ側で動的なページ生成を行う機構があれば、
ロングテールでのページのクローリングを狙うことができます。
ちなみに、ロングテールをざっくり説明すると、 <strong>単体の検索ボリュームでは少ないけど、複数カテゴリの検索クエリの組み合わせのバリエーションに対応することで、検索ボリュームの総和に対してリーチする</strong> 方法です。</p>

<h3 id="問題点アクセスが少ない時期はランニングコストが高くつく">問題点：アクセスが少ない時期はランニングコストが高くつく</h3>
<p>従来、動的なwebコンテンツを作成しようとする場合、<strong>ページ生成プログラムを動かすためのサーバが必要</strong> でした。
環境調達の方法としては「レンタルサーバを借りる」のが一般的ですが、バンドルされている <a href="https://ja.wordpress.org/">WordPress</a> で要件が充足されないケースがある場合には、<code class="highlighter-rouge">VPS</code> サービスを契約しなければいけません。
VPSサービスは通常のレンタルサーバよりもランニングコストが少しお高めになってしまいます。</p>

<p>参考までに2種類のサービス料金を記載しますが、コンテンツ配信のための月額料金がボディブローのようにじわじわ効いてくることが容易に想像できます。</p>

<table>
  <tbody>
    <tr>
      <td>サービス名</td>
      <td>月額料金(最低スペック)</td>
    </tr>
  </tbody>
  <tfoot>
    <tr>
      <td><a href="https://vps.sakura.ad.jp/">さくらのVPS</a></td>
      <td>685JPY/month 〜</td>
    </tr>
    <tr>
      <td><a href="https://vps.gmocloud.com/">GMOクラウド</a></td>
      <td>780JPY/month 〜</td>
    </tr>
  </tfoot>
</table>

<h3 id="サーバレスで費用を抑えよう">サーバレスで費用を抑えよう</h3>
<p>前提として、<strong>プログラミングに関する知識が必要にはなります</strong> が、パブリッククラウドを使用することでサーバのランニングコストを抑えることができます。
ざっくりですがパブリッククラウドを用いた構成案と勘案要素を以下にまとめました。いずれの案においても、<strong>最低利用料金 + リクエスト量に応じた従量課金</strong> というコスト構造になるので、VPSよりも割安なのですが、今回は利便性と最低利用料金のバランスが良い <strong>案1 Cloudfront + Lambda@Edge</strong> を今回採用しました。</p>

<h4 id="案1-cloudfront--lambdaedge">案1 Cloudfront + Lambda@Edge</h4>

<ul>
  <li>メリット
    <ul>
      <li>サーバレス</li>
      <li>CDNキャッシュが効く</li>
    </ul>
  </li>
  <li>デメリット
    <ul>
      <li>Lambda@Edgeは無料利用枠がない</li>
      <li>Node 6.10 しか利用できない</li>
      <li>その他、通常のLambdaよりも<a href="https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/cloudfront-limits.html#limits-lambda-at-edge">制限事項が多い</a></li>
    </ul>
  </li>
</ul>

<h4 id="案2-api-gateway--lambda">案2 API Gateway + Lambda</h4>

<ul>
  <li>メリット
    <ul>
      <li>サーバレス</li>
      <li>Lambdaがサポートしている複数言語での開発が可能</li>
      <li>CDNキャッシュが効く</li>
    </ul>
  </li>
  <li>デメリット
    <ul>
      <li>API Gatewayの最低利用料金がCloudfrontと比べて高い</li>
    </ul>
  </li>
</ul>

<h4 id="案3-gcpのgce-f1-micro-インスタンス">案3 GCPのGCE f1-micro インスタンス</h4>

<ul>
  <li>メリット
    <ul>
      <li>おそらく利用料金が最も安く抑えられる</li>
    </ul>
  </li>
  <li>デメリット
    <ul>
      <li>ロケーションが遠いので、レイテンシが気になる</li>
      <li>Cloud CDN と組み合わせるとf1-microインスタンス料金無料の旨味が消える</li>
      <li>インスタンスの設定(ランタイムとかSSL証明書のインストールとか)が必要</li>
    </ul>
  </li>
</ul>

<h2 id="awsで構築してみる">AWSで構築してみる</h2>
<p>以降は案1での構築方法を記載していきます。</p>

<h3 id="iam-roleの作成">IAM Roleの作成</h3>

<p>Lambdaに付与するIAM Roleを作成します。
まず、以下のようなAssume Role Policy を作成します。
 <code class="highlighter-rouge">Lambda</code> と <code class="highlighter-rouge">Lambda@Edge</code> は別ものとして扱われているため、 <code class="highlighter-rouge">edgelambda.amazonaws.com</code> の記載が必要です。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"Service"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"edgelambda.amazonaws.com"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"lambda.amazonaws.com"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>作成したPolicyと <code class="highlighter-rouge">CloudWatchLogsFullAccess</code> のポリシーをアタッチしたRoleを作成します。
名前はとりあえず <strong>EdgeLambdaForCloudfrontRole</strong> としましょう。</p>

<h3 id="ドメインを設定する">ドメインを設定する</h3>
<p>Cloudfrontのディストリビューションのドメインをそのまま使うわけには行かないので、ドメインを設定します。
個人的にはお金を払い、 <code class="highlighter-rouge">.com</code> や <code class="highlighter-rouge">.net</code> のような信頼のあるドメインを確保することをオススメします。
ドメイン料金も抑えたい方は <strong>「ドメイン 無料」</strong> で検索すればいくらでも無料ドメインサービスが出てくるので、それを活用してください。</p>

<p>私が取得しているドメインは <a href="https://www.cloudflare.com/">Cloudflare</a> で管理しているので、
Route53で取得しているドメインのサブドメインのHosted Zoneを作成し、NSレコードをCloudflare上に登録してあげます。</p>

<h3 id="certification-managerでssl証明書を取得する">Certification ManagerでSSL証明書を取得する</h3>

<p>サブドメインの委譲が正しくできていれば(= Route53上の設定値でDNSが引けるようになれば) Certification Manager を用いてSSL証明書を取得しましょう。
SSL証明書の取得に関してはDNS Validationでやり方をオススメします。 詳しくは以前のポスト <a href="/aws/validate-certification-manager">AWS Certification ManagerのSSL証明書の検証にはDNS検証を使った方が良い</a> を見てみてください。
注意点として、<strong>SSL証明書は us-east-1(Virginia)リージョンで取得する必要があります</strong> 。
これは「Cloudfrontに適用可能なSSL証明書はVirginiaリージョンで発行されたもののみ」という仕様のためです。</p>

<h3 id="lambda関数の作成とpublish">Lambda関数の作成とpublish</h3>

<p>次にLambda関数の実装を行います。 <strong>Lambda@EdgeはNode 6.10のみをサポートしているため、Nodeでの実装が必要です</strong> 。
軽量なwebアプリケーションを作成する手段として、手っ取り早いのは <a href="https://www.npmjs.com/package/express">express</a> を使う方法です。
expressの使い方の説明は割愛しますが、実装時に注意すべき点だけ記載します。</p>

<h4 id="lambdaedgeはcloudfrontのオリジンリクエスト時に実行させる">Lambda@EdgeはCloudfrontのオリジンリクエスト時に実行させる</h4>

<p>Lambda@EdgeとCloudfrontを連携させる場合に、Lambda@Edgeの実行タイミングを4つのうちから選択することができます。
詳細は<a href="https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/lambda-cloudfront-trigger-events.html">開発者ガイド</a> に記載されています。</p>

<ul>
  <li>CloudFront ビューワーリクエスト
    <ul>
      <li>リクエストをCloudfrontが受ける前にLambda@Edgeが処理をする(Lambda@Edge -&gt; Cloudfront -&gt; Origin)</li>
    </ul>
  </li>
  <li>CloudFront オリジンリクエスト
    <ul>
      <li>リクエストをCloudfrontが受けた後にLambda@Edgeが処理をする(Cloudfront -&gt; Lambda@Edge -&gt; Origin)</li>
    </ul>
  </li>
  <li>CloudFront オリジンレスポンス
    <ul>
      <li>オリジンからのレスポンスをCloudfrontに返却する前にLambda@Edgeが処理をする(Cloudfront &lt;- Lambda@Edge &lt;- Origin)</li>
    </ul>
  </li>
  <li>CloudFront ビューワーのレスポンス
    <ul>
      <li>Cloudfrontがクライアントにレスポンスを返却する前にLambda@Edgeが処理をする(Lambda@Edge &lt;- Cloudfront &lt;- Origin)</li>
    </ul>
  </li>
</ul>

<p><strong>CloudFront オリジンリクエスト</strong> で実行することを選択しましょう。これにより、Originの代わりにLambda@Edgeがレスポンスを返せるようになります。
<code class="highlighter-rouge">ビューワーリクエスト</code> にしてしまうと、CDNのキャッシュが活用できなくなりますし、 <code class="highlighter-rouge">オリジンレスポンス</code> にすると一度リクエストを受けるためのオリジンをS3などで作成しないといけなくなります。</p>

<h4 id="lambdaedgeからcloudfrontへのレスポンス形式に注意する">Lambda@EdgeからCloudfrontへのレスポンス形式に注意する</h4>
<p><code class="highlighter-rouge">オリジンリクエスト</code> の場合、Lambda@EdgeからCloudfrontに返却するレスポンスの形式が以下のように定められているため、そちらに準拠する必要があります。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="nl">body</span><span class="p">:</span> <span class="s1">'content'</span><span class="p">,</span>
    <span class="nx">bodyEncoding</span><span class="p">:</span> <span class="s1">'text'</span> <span class="o">|</span> <span class="s1">'base64'</span><span class="p">,</span>
    <span class="nx">headers</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'header name in lowercase'</span><span class="p">:</span> <span class="p">[{</span>
            <span class="na">key</span><span class="p">:</span> <span class="s1">'header name in standard case'</span><span class="p">,</span>
            <span class="na">value</span><span class="p">:</span> <span class="s1">'header value'</span>
         <span class="p">}],</span>
         <span class="p">...</span>
    <span class="p">},</span>
    <span class="nx">status</span><span class="p">:</span> <span class="s1">'HTTP status code'</span><span class="p">,</span>
    <span class="nx">statusDescription</span><span class="p">:</span> <span class="s1">'status description'</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これを愚直に実装するのは少々手間がかかるので、 <a href="https://github.com/jgautheron/aws-serverless-express-edge">aws-serverless-express-edge</a> というnpmモジュールを使ってしまうのが早いです。</p>

<h3 id="cloudfrontで配信する">Cloudfrontで配信する</h3>

<p>最後にCloudfrontの配信設定を行います。Cloudfront自体の使い方は公式のドキュメントを読んでいただければ問題ないので、ここでも注意点にだけ触れておきます。</p>

<h4 id="lambda関数はpublishして使う">Lambda関数はpublishして使う</h4>

<p>Lambda@EdgeをCloudfrontと連携させる場合、<strong>Lambda関数はpublishしておく必要があります</strong> 。
Cloudfrontでは実行するLambda@EdgeのARNをバージョン番号込みで指定する必要があり、<code class="highlighter-rouge">$LATEST</code> による指定はサポート外であるため、
Lambda関数の更新の都度バージョンを上げていくスタイルになります。
一番良い方法としてオススメなのは、<a href="https://www.terraform.io/">Terraform</a> を使ってCloudfrontとLambdaのコード化をしてしまうことです。</p>

<p>Cloudfrontは設定項目が多いためTerraformに書き起こすのに時間がかかりますが、後々の更新コストを加味して早めに対応しておきましょう。</p>

<ul>
  <li>LambdaのTerraformサンプル</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource <span class="s2">"aws_lambda_function"</span> <span class="s2">"hogehoge"</span> <span class="o">{</span>
    filename <span class="o">=</span> <span class="s2">"../hogehoge.zip"</span>
    function_name <span class="o">=</span> <span class="s2">"hoeghoge"</span>
    publish <span class="o">=</span> <span class="nb">true
    </span>role <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">EdgeLambdaForCloudfrontRole</span><span class="p">のARN</span><span class="k">}</span><span class="s2">"</span>
    handler <span class="o">=</span> <span class="s2">"index.handler"</span>
    source_code_hash <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">data</span><span class="p">.archive_file.hogehoge.output_base64sha256</span><span class="k">}</span><span class="s2">"</span>
    runtime <span class="o">=</span> <span class="s2">"nodejs6.10"</span>
    timeout <span class="o">=</span> 30
<span class="o">}</span>

data <span class="s2">"archive_file"</span> <span class="s2">"hogehoge"</span> <span class="o">{</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="s2">"zip"</span>
    source_dir  <span class="o">=</span> <span class="s2">"../workspace"</span>
    output_path <span class="o">=</span> <span class="s2">"../hogehoge.zip"</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>CloudfrontのTerraformサンプル</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource <span class="s2">"aws_cloudfront_distribution"</span> <span class="s2">"hogehogefront_cloudfront"</span> <span class="o">{</span>
    origin <span class="o">{</span>
        domain_name <span class="o">=</span> <span class="s2">"xxxx.soudegesu.com"</span>
        origin_id   <span class="o">=</span> <span class="s2">"Custom-your-xxxx.soudegesu.com"</span>
        custom_origin_config <span class="o">{</span>
            http_port <span class="o">=</span> 80
            https_port <span class="o">=</span> 443
            origin_protocol_policy <span class="o">=</span> <span class="s2">"http-only"</span>
            origin_ssl_protocols <span class="o">=</span> <span class="o">[</span><span class="s2">"TLSv1"</span>, <span class="s2">"TLSv1.1"</span>, <span class="s2">"TLSv1.2"</span><span class="o">]</span>
        <span class="o">}</span>
    <span class="o">}</span>
    aliases <span class="o">=</span> <span class="o">[</span><span class="s2">"xxxx.soudegesu.com"</span><span class="o">]</span>
    enabled <span class="o">=</span> <span class="nb">true
    </span>is_ipv6_enabled <span class="o">=</span> <span class="nb">true
    </span>comment <span class="o">=</span> <span class="s2">"tools distribution"</span>

    default_cache_behavior <span class="o">{</span>
        allowed_methods  <span class="o">=</span> <span class="o">[</span><span class="s2">"GET"</span>, <span class="s2">"HEAD"</span>, <span class="s2">"OPTIONS"</span><span class="o">]</span>
        cached_methods   <span class="o">=</span> <span class="o">[</span><span class="s2">"GET"</span>, <span class="s2">"HEAD"</span><span class="o">]</span>
        target_origin_id <span class="o">=</span> <span class="s2">"Custom-xxxx.soudegesu.com"</span>

        forwarded_values <span class="o">{</span>
            query_string <span class="o">=</span> <span class="nb">false

            </span>cookies <span class="o">{</span>
                forward <span class="o">=</span> <span class="s2">"none"</span>
            <span class="o">}</span>
        <span class="o">}</span>

        viewer_protocol_policy <span class="o">=</span> <span class="s2">"redirect-to-https"</span>
        min_ttl <span class="o">=</span> 86400
        default_ttl <span class="o">=</span> 604800
        max_ttl <span class="o">=</span> 2592000
        compress <span class="o">=</span> <span class="nb">true
        </span>lambda_function_association <span class="o">{</span>
            event_type <span class="o">=</span> <span class="s2">"origin-request"</span>
            lambda_arn <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">aws_lambda_function</span><span class="p">.hogehoge.qualified_arn</span><span class="k">}</span><span class="s2">"</span>
        <span class="o">}</span>
    <span class="o">}</span>

    viewer_certificate <span class="o">{</span>
        acm_certificate_arn <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ACM</span><span class="p">のARN</span><span class="k">}</span><span class="s2">"</span>
        minimum_protocol_version <span class="o">=</span> <span class="s2">"TLSv1.1_2016"</span>
        ssl_support_method <span class="o">=</span> <span class="s2">"sni-only"</span>
    <span class="o">}</span>

    restrictions <span class="o">{</span>
        geo_restriction <span class="o">{</span>
            restriction_type <span class="o">=</span> <span class="s2">"none"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ポイントなのは Cloudfront側の以下の部分で、</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    lambda_function_association <span class="o">{</span>
        event_type <span class="o">=</span> <span class="s2">"origin-request"</span>
        lambda_arn <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">aws_lambda_function</span><span class="p">.hogehoge.qualified_arn</span><span class="k">}</span><span class="s2">"</span>
    <span class="o">}</span>

</code></pre></div></div>

<p><code class="highlighter-rouge">qualified_arn</code> を指定すると、バージョン込のフルのARNにて変数展開がされます。
これにより、terraformを実行するだけで、LambdaのデプロイとCloudfrontの更新の両方ができるようになります。</p>

<h4 id="キャシュクリアをする2回目以降のデプロイ時">キャシュクリアをする(2回目以降のデプロイ時)</h4>

<p>CloudfrontはCDNサービスなので、デプロイ後にキャッシュをクリアして上げた方がよいです。</p>

<p>AWSコンソールからCloudfrontのInvalidationsのタブを押します。</p>

<p><img src="/assets/images/20180403/invalidations.png" alt="invalidations" /></p>

<p>全てのURLのキャッシュをクリアしたいので、「*」を指定すればOKです。</p>

<p><img src="/assets/images/20180403/invalidation_target.png" alt="invalidation_target" /></p>

<p>なお、このキャッシュクリアに関してCloudfrontの料金ページでは、</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>月間で無効をリクエストしたパスの最初の 1,000 パスまでは追加料金なし。それ以降は、無効をリクエストしたパスごとに 0.005 USD かかります。
</code></pre></div></div>

<p>と記載されているので、URLのパターンが増えてきたら、削除対象の指定パターンはもう少し工夫した方がいいかもしれません。</p>

<h2 id="まとめ">まとめ</h2>

<p>今回、Cloudfront + Lambda@Edgeを用いてサーバレスでのwebコンテンツを配信する仕組みを構築しました。
実際にサンプルコンテンツを作成してみたのが <a href="http://www.tools.soudegesu.com/">こちら</a> になります。
ブラウザの言語設定の情報を基に <code class="highlighter-rouge">ja</code> か <code class="highlighter-rouge">en</code> かにリダイレクトする機能(俗に言うi18n対応っぽいもの)を実現しています。</p>

<p>1週間程寝かせてみた後のAWS Billing Dashboardは以下のようになりました。$1到達していないですね。素晴らしい。</p>

<p><img src="/assets/images/20180403/billing_dashborad.png" alt="billing dashboard" /></p>

<p>立ち上げ期のアクセスが少ないコンテンツでは、ランニングコストが大きくならないようにサーバレスで節約していきたいですね！</p>

<h2 id="参考にさせていただいたサイト">参考にさせていただいたサイト</h2>
<ul>
  <li><a href="https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/lambda-generating-http-responses.html">Amazon Cloudfront 開発者ガイド</a></li>
</ul>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="https://www.soudegesu.com/tags/aws" class="page__taxonomy-item" rel="tag">aws</a><span class="sep">, </span>
    
      
      
      <a href="https://www.soudegesu.com/tags/cloudfront" class="page__taxonomy-item" rel="tag">cloudfront</a><span class="sep">, </span>
    
      
      
      <a href="https://www.soudegesu.com/tags/lambda" class="page__taxonomy-item" rel="tag">lambda</a><span class="sep">, </span>
    
      
      
      <a href="https://www.soudegesu.com/tags/nodejs" class="page__taxonomy-item" rel="tag">nodejs</a><span class="sep">, </span>
    
      
      
      <a href="https://www.soudegesu.com/tags/serverless" class="page__taxonomy-item" rel="tag">serverless</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="https://www.soudegesu.com/categories/aws" class="page__taxonomy-item" rel="tag">aws</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-04-03T00:00:00+09:00">April 03, 2018</time></p>
        
      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?via=alten_manten&text=Cloudfront+Lambda@Edgeのサーバレス構成で費用を抑えつつ、動的なWEBコンテンツを作ろう[貧テック] https://www.soudegesu.com/aws/hosting-with-cloudfront-lambda-edge-serverless/" class="btn btn--twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer.php?u=https://www.soudegesu.com/aws/hosting-with-cloudfront-lambda-edge-serverless/" class="btn btn--facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=https://www.soudegesu.com/aws/hosting-with-cloudfront-lambda-edge-serverless/" class="btn btn--google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.soudegesu.com/aws/hosting-with-cloudfront-lambda-edge-serverless/" class="btn btn--linkedin" title="Share on LinkedIn"><i class="fa fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>

  <a href="http://b.hatena.ne.jp/append?https://www.soudegesu.com/aws/hosting-with-cloudfront-lambda-edge-serverless/" class="btn btn--hatebu" title="Share on Bookmark"><i class="fa fa-fw fa-hatebu" aria-hidden="true"></i><span> Bookmark</span></a>

</section>


    </div>

    
  <nav class="pagination">
    
      <a href="https://www.soudegesu.com/java/non-blocking-webflux/" class="pagination--pager" title="springboot-webfluxのバックプレッシャーを体験してたらいい感じだった
">Previous</a>
    
    
      <a href="https://www.soudegesu.com/aws/deploy-lambda-with-terraform/" class="pagination--pager" title="AWS LambdaのコードをTerraformでデプロイする
">Next</a>
    
  </nav>


    
      <div class="page__comments">
  
  
    <h4 class="page__comments-title">Comments</h4>
    <section id="disqus_thread"></section>
  
</div>

    

  </article>
  
  
  <div class="page__related">
    <h2 class="page__related-title">関連記事</h2>
    
    
    

    <div class="grid__wrapper">
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        

          



<div class="list__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="https://www.soudegesu.com/aws/amazonlinux2-docker/" rel="permalink">Amazon Linux2にdockerをインストールする
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">AMIをAmazon Linux2に変更したのですが、 yum install docker でdockerがインストールできなくなってしまったので対処方法を調査しました。

</p>
  </article>
</div>

          
          
        
      
        
        
  
        

          



<div class="list__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="https://www.soudegesu.com/aws/aws-batch-and-glue/" rel="permalink">AWS Batchで前処理をしてGlue CrawlerでAthenaのスキーマを作成する
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">以前、 S3にエクスポートされたCloudWatch LogsのファイルをGlueのCrawlerでETLしようとして轟沈した話 でGlueを少し触ってみたのですが、今回はAWS Batchで前処理 + Glue CrawlerでAthenaのスキーマを自動生成しました、という話をしようと思います。

</p>
  </article>
</div>

          
          
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        

          



<div class="list__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="https://www.soudegesu.com/aws/export-cloudwatchlogs-to-s3/" rel="permalink">Step FunctionsでCloudWatch LogsのロググループをS3へエクスポートする
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  3 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">CloudWatch LogsにはロググループをS3にエクスポートする機能がついています。
しかし、エクスポート機能には同時実行数制限があるので、 今回は Step Functions を使ってS3へのログのエクスポートを実現しました。

</p>
  </article>
</div>

          
          
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        

          



<div class="list__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="https://www.soudegesu.com/nodejs/express-sitemap-module/" rel="permalink">Expressのサイトマップ生成用npmモジュール（express-sitemapとsitemap）を比較しよう
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">以前書いた 「Cloudfront+Lambda@Edgeのサーバレス構成で費用を抑えつつ、動的なWEBコンテンツを作ろう」 の記事で、Node.jsの express アプリケーションを作成しました。

</p>
  </article>
</div>

          
          
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        
      
        
        
  
        

          



<div class="list__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="https://www.soudegesu.com/aws/casperjs-on-lambda/" rel="permalink">AWS LambdaでCasperJSを実行してファイルアップロードを自動化する
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">AWS上のデータを別サービスに連携するために、AWS LambdaからCasperJSを使ってファイル配置を自動化する仕組みを作ってみました。
APIでデータをPOSTできれば簡単なのですが、今回はGUI上からファイルをアップロードしないといけないため、技術の無駄遣いをしてみます。

</p>
  </article>
</div>

          
          
            
    </div>      
  </div>
  

  

</div>


    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
    
      <li><a href="https://twitter.com/alten_manten"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
      <li><a href="http://github.com/soudegesu"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    <li><a href="https://www.soudegesu.com/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    <li><a href="/sitemap/"><i class="fa fa-fw fa-sitemap" aria-hidden="true"></i> Sitemap</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 soudegsu. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

<amp-auto-ads type="adsense"data-ad-client="ca-pub-5005266309965277"></amp-auto-ads>

      </footer>
    </div>

    <script src="https://www.soudegesu.com/assets/js/main.min.js"></script>




  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92599175-1', 'auto');
  ga('send', 'pageview');
</script>



<script async custom-element="amp-auto-ads"src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js" />




  
  <script type="text/javascript">
  	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  	var disqus_shortname = 'soudegesu';

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function() {
  		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  	})();

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function () {
  		var s = document.createElement('script'); s.async = true;
  		s.type = 'text/javascript';
  		s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  		(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  	}());
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






  </body>
</html>
